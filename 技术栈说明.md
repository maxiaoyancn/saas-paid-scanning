# 收费软件检测系统 - 技术栈说明
## Tech Stack Documentation

---

## 🔧 技术栈概览

### 后端技术栈 (Golang)
```
语言：Golang 1.21+
Web框架：Gin (高性能HTTP框架)
ORM：GORM (Go语言ORM库)
数据库：PostgreSQL + Redis
任务队列：Asynq (基于Redis的分布式任务队列)
消息队列：RabbitMQ (amqp091-go)
```

### 前端技术栈 (React)
```
语言：TypeScript
框架：React 18+
状态管理：Redux Toolkit / Zustand
UI组件库：Ant Design / Material-UI
构建工具：Vite / Create React App
图表库：Chart.js / Recharts
```

### 桌面客户端
```
框架：Electron + React
语言：TypeScript
打包：electron-builder
更新：electron-updater
```

---

## 📦 核心依赖包

### Golang后端依赖

#### Web框架和中间件
```go
// go.mod
module saas-scanning-system

go 1.21

require (
    github.com/gin-gonic/gin v1.9.1
    github.com/gin-contrib/cors v1.4.0
    github.com/gin-contrib/pprof v1.4.0
    github.com/gin-contrib/requestid v0.0.6
)
```

#### 数据库和缓存
```go
require (
    gorm.io/gorm v1.25.5
    gorm.io/driver/postgres v1.5.4
    github.com/go-redis/redis/v8 v8.11.5
    github.com/golang-migrate/migrate/v4 v4.16.2
)
```

#### 认证和安全
```go
require (
    github.com/golang-jwt/jwt/v4 v4.5.0
    golang.org/x/crypto v0.14.0
    github.com/casbin/casbin/v2 v2.77.2
)
```

#### 任务队列和消息
```go
require (
    github.com/hibiken/asynq v0.24.1
    github.com/streadway/amqp v1.1.0
    github.com/gorilla/websocket v1.5.0
)
```

#### 监控和日志
```go
require (
    github.com/sirupsen/logrus v1.9.3
    github.com/prometheus/client_golang v1.17.0
    go.opentelemetry.io/otel v1.19.0
    go.opentelemetry.io/otel/exporters/jaeger v1.17.0
)
```

#### 工具库
```go
require (
    github.com/spf13/viper v1.17.0  // 配置管理
    github.com/google/uuid v1.3.1   // UUID生成
    github.com/robfig/cron/v3 v3.0.1 // 定时任务
    gonum.org/v1/gonum v0.14.0      // 数学计算
)
```

### React前端依赖

#### package.json
```json
{
  "name": "saas-scanning-frontend",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "typescript": "^5.0.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0"
  }
}
```

#### 状态管理和路由
```json
{
  "dependencies": {
    "@reduxjs/toolkit": "^1.9.7",
    "react-redux": "^8.1.3",
    "react-router-dom": "^6.17.0",
    "zustand": "^4.4.4"
  }
}
```

#### UI组件和样式
```json
{
  "dependencies": {
    "antd": "^5.11.0",
    "@ant-design/icons": "^5.2.6",
    "styled-components": "^6.1.0",
    "tailwindcss": "^3.3.5"
  }
}
```

#### 图表和可视化
```json
{
  "dependencies": {
    "chart.js": "^4.4.0",
    "react-chartjs-2": "^5.2.0",
    "recharts": "^2.8.0",
    "d3": "^7.8.5"
  }
}
```

#### HTTP客户端和工具
```json
{
  "dependencies": {
    "axios": "^1.6.0",
    "react-query": "^3.39.3",
    "dayjs": "^1.11.10",
    "lodash": "^4.17.21"
  }
}
```

---

## 🏗️ 项目结构

### 后端项目结构 (Golang)
```
saas-scanning-backend/
├── cmd/
│   ├── auth/           # 认证服务
│   ├── scanner/        # 扫描服务
│   ├── risk/           # 风险评估服务
│   ├── analytics/      # 数据分析服务
│   └── notification/   # 通知服务
├── internal/
│   ├── auth/           # 认证模块
│   ├── scanner/        # 扫描模块
│   ├── risk/           # 风险评估模块
│   ├── analytics/      # 分析模块
│   ├── notification/   # 通知模块
│   ├── common/         # 公共模块
│   │   ├── config/     # 配置管理
│   │   ├── database/   # 数据库连接
│   │   ├── cache/      # 缓存管理
│   │   ├── middleware/ # 中间件
│   │   └── utils/      # 工具函数
│   └── models/         # 数据模型
├── pkg/                # 公共包
│   ├── logger/         # 日志包
│   ├── validator/      # 验证包
│   └── errors/         # 错误处理
├── api/                # API定义
│   └── openapi/        # OpenAPI规范
├── configs/            # 配置文件
├── scripts/            # 脚本文件
├── deployments/        # 部署文件
│   ├── docker/         # Docker文件
│   └── k8s/            # Kubernetes配置
├── docs/               # 文档
├── go.mod
├── go.sum
└── Makefile
```

### 前端项目结构 (React)
```
saas-scanning-frontend/
├── public/             # 静态资源
├── src/
│   ├── components/     # 公共组件
│   │   ├── common/     # 通用组件
│   │   ├── charts/     # 图表组件
│   │   └── forms/      # 表单组件
│   ├── pages/          # 页面组件
│   │   ├── dashboard/  # 仪表板
│   │   ├── scan/       # 扫描页面
│   │   ├── reports/    # 报告页面
│   │   └── settings/   # 设置页面
│   ├── hooks/          # 自定义Hooks
│   ├── services/       # API服务
│   ├── store/          # 状态管理
│   │   ├── slices/     # Redux切片
│   │   └── index.ts    # Store配置
│   ├── utils/          # 工具函数
│   ├── types/          # TypeScript类型定义
│   ├── styles/         # 样式文件
│   ├── assets/         # 静态资源
│   ├── App.tsx
│   ├── index.tsx
│   └── vite-env.d.ts
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

---

## 🔌 服务间通信

### HTTP REST API
```go
// API路由定义
func SetupRoutes(r *gin.Engine) {
    api := r.Group("/api/v1")
    
    // 认证相关
    auth := api.Group("/auth")
    {
        auth.POST("/login", handleLogin)
        auth.POST("/register", handleRegister)
        auth.POST("/refresh", handleRefreshToken)
    }
    
    // 扫描相关
    scan := api.Group("/scan")
    scan.Use(authMiddleware.RequireAuth())
    {
        scan.POST("/start", handleStartScan)
        scan.GET("/results/:id", handleGetScanResults)
        scan.GET("/history", handleGetScanHistory)
    }
    
    // 风险评估
    risk := api.Group("/risk")
    risk.Use(authMiddleware.RequireAuth())
    {
        risk.GET("/assessment/:software_id", handleGetRiskAssessment)
        risk.POST("/bulk-assess", handleBulkAssessment)
    }
}
```

### gRPC服务间调用
```go
// risk_service.proto
syntax = "proto3";

package risk;

service RiskAssessmentService {
    rpc AssessRisk(AssessRiskRequest) returns (AssessRiskResponse);
    rpc BulkAssess(BulkAssessRequest) returns (BulkAssessResponse);
}

message AssessRiskRequest {
    string software_id = 1;
    SoftwareInfo software_info = 2;
}

message AssessRiskResponse {
    int32 risk_score = 1;
    string risk_level = 2;
    repeated string reasons = 3;
}
```

### WebSocket实时通信
```go
// WebSocket处理器
func handleWebSocket(c *gin.Context) {
    conn, err := upgrader.Upgrade(c.Writer, c.Request, nil)
    if err != nil {
        log.Printf("WebSocket upgrade failed: %v", err)
        return
    }
    defer conn.Close()
    
    client := &Client{
        conn: conn,
        send: make(chan []byte, 256),
    }
    
    hub.register <- client
    
    go client.writePump()
    go client.readPump()
}
```

---

## 📊 数据库设计

### GORM模型定义
```go
// 用户模型
type User struct {
    ID               uint      `gorm:"primarykey" json:"id"`
    Username         string    `gorm:"uniqueIndex;not null" json:"username"`
    Email            string    `gorm:"uniqueIndex;not null" json:"email"`
    PasswordHash     string    `gorm:"not null" json:"-"`
    Role             string    `gorm:"default:user" json:"role"`
    SubscriptionType string    `gorm:"default:free" json:"subscription_type"`
    CreatedAt        time.Time `json:"created_at"`
    UpdatedAt        time.Time `json:"updated_at"`
    
    // 关联
    Devices     []Device     `gorm:"foreignKey:UserID" json:"devices,omitempty"`
    ScanResults []ScanResult `gorm:"foreignKey:UserID" json:"scan_results,omitempty"`
}

// 软件信息模型
type Software struct {
    ID                     uint      `gorm:"primarykey" json:"id"`
    Name                   string    `gorm:"not null" json:"name"`
    Vendor                 string    `json:"vendor"`
    Version                string    `json:"version"`
    LicenseType            string    `json:"license_type"`
    CommercialUseAllowed   bool      `json:"commercial_use_allowed"`
    IndividualUseFree      bool      `json:"individual_use_free"`
    RiskLevel              int       `gorm:"check:risk_level >= 0 AND risk_level <= 100" json:"risk_level"`
    LastPolicyChange       *time.Time `json:"last_policy_change"`
    DataCollection         bool      `gorm:"default:false" json:"data_collection"`
    NetworkActivityLevel   int       `gorm:"default:0" json:"network_activity_level"`
    FingerprintHash        string    `gorm:"index" json:"fingerprint_hash"`
    CreatedAt              time.Time `json:"created_at"`
    UpdatedAt              time.Time `json:"updated_at"`
    
    // 关联
    ScanResults []ScanResult `gorm:"foreignKey:SoftwareID" json:"scan_results,omitempty"`
}

// 扫描结果模型
type ScanResult struct {
    ID              uint      `gorm:"primarykey" json:"id"`
    UserID          uint      `gorm:"not null" json:"user_id"`
    DeviceID        uint      `gorm:"not null" json:"device_id"`
    SoftwareID      uint      `gorm:"not null" json:"software_id"`
    DetectedVersion string    `json:"detected_version"`
    InstallationPath string   `json:"installation_path"`
    FileSize        int64     `json:"file_size"`
    InstallDate     *time.Time `json:"install_date"`
    LastUsed        *time.Time `json:"last_used"`
    UsageFrequency  int       `gorm:"default:0" json:"usage_frequency"`
    RiskScore       int       `json:"risk_score"`
    ScanDate        time.Time `gorm:"default:CURRENT_TIMESTAMP" json:"scan_date"`
    Status          string    `gorm:"default:active" json:"status"` // active, removed, updated, ignored
    
    // 关联
    User     User     `gorm:"foreignKey:UserID" json:"user,omitempty"`
    Device   Device   `gorm:"foreignKey:DeviceID" json:"device,omitempty"`
    Software Software `gorm:"foreignKey:SoftwareID" json:"software,omitempty"`
}
```

---

## 🚀 部署和运维

### Docker Compose开发环境
```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # 数据库
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: saas_scanning
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
  
  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  
  # 认证服务
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile.dev
    ports:
      - "8081:8080"
    environment:
      - DATABASE_URL=postgres://postgres:password@postgres:5432/saas_scanning?sslmode=disable
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./services/auth:/app
      - /app/tmp
  
  # 扫描服务
  scanner-service:
    build:
      context: ./services/scanner
      dockerfile: Dockerfile.dev
    ports:
      - "8082:8080"
    environment:
      - DATABASE_URL=postgres://postgres:password@postgres:5432/saas_scanning?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://admin:password@rabbitmq:5672/
    depends_on:
      - postgres
      - redis
      - rabbitmq
    volumes:
      - ./services/scanner:/app
      - /app/tmp

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
```

### Makefile命令
```makefile
# Makefile
.PHONY: help build test run clean docker-build docker-up docker-down

# 默认目标
help:
	@echo "可用命令:"
	@echo "  build        - 编译所有服务"
	@echo "  test         - 运行测试"
	@echo "  run          - 运行开发环境"
	@echo "  clean        - 清理构建文件"
	@echo "  docker-build - 构建Docker镜像"
	@echo "  docker-up    - 启动开发环境"
	@echo "  docker-down  - 停止开发环境"

# 编译所有服务
build:
	@echo "编译认证服务..."
	cd services/auth && go build -o ../../bin/auth-service ./cmd/main.go
	@echo "编译扫描服务..."
	cd services/scanner && go build -o ../../bin/scanner-service ./cmd/main.go
	@echo "编译风险评估服务..."
	cd services/risk && go build -o ../../bin/risk-service ./cmd/main.go

# 运行测试
test:
	@echo "运行测试..."
	cd services/auth && go test -v ./...
	cd services/scanner && go test -v ./...
	cd services/risk && go test -v ./...

# 运行开发环境
run:
	docker-compose -f docker-compose.dev.yml up --build

# 清理构建文件
clean:
	rm -rf bin/
	rm -rf tmp/
	go clean -cache

# 构建Docker镜像
docker-build:
	docker build -t saas-scanning/auth-service:latest ./services/auth
	docker build -t saas-scanning/scanner-service:latest ./services/scanner
	docker build -t saas-scanning/risk-service:latest ./services/risk

# 启动开发环境
docker-up:
	docker-compose -f docker-compose.dev.yml up -d

# 停止开发环境
docker-down:
	docker-compose -f docker-compose.dev.yml down
```

---

## 📈 性能优化

### 数据库优化
```go
// 数据库连接池配置
func setupDatabase() *gorm.DB {
    dsn := os.Getenv("DATABASE_URL")
    
    db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Info),
        NamingStrategy: schema.NamingStrategy{
            SingularTable: true,
        },
    })
    if err != nil {
        log.Fatal("Failed to connect to database:", err)
    }
    
    sqlDB, err := db.DB()
    if err != nil {
        log.Fatal("Failed to get database instance:", err)
    }
    
    // 连接池配置
    sqlDB.SetMaxIdleConns(10)
    sqlDB.SetMaxOpenConns(100)
    sqlDB.SetConnMaxLifetime(time.Hour)
    
    return db
}
```

### Redis缓存优化
```go
// Redis连接配置
func setupRedis() *redis.Client {
    rdb := redis.NewClient(&redis.Options{
        Addr:         os.Getenv("REDIS_URL"),
        Password:     "",
        DB:           0,
        PoolSize:     10,
        PoolTimeout:  30 * time.Second,
        IdleTimeout:  5 * time.Minute,
        ReadTimeout:  3 * time.Second,
        WriteTimeout: 3 * time.Second,
    })
    
    // 测试连接
    ctx := context.Background()
    _, err := rdb.Ping(ctx).Result()
    if err != nil {
        log.Fatal("Failed to connect to Redis:", err)
    }
    
    return rdb
}
```

---

*文档版本：v1.0*  
*创建时间：2024年12月*  
*维护团队：技术团队*
